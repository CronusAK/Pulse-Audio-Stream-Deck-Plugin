<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Push to Talk Settings</title>
  <link rel="stylesheet" href="sdpi.css" />
</head>
<body>
  <div class="sdpi-wrapper">
    <div class="sdpi-heading">Push to Talk</div>
    <div class="sdpi-item">
      <div class="sdpi-item-label">Microphone</div>
      <div class="sdpi-item-value">
        <select id="input-select">
          <option value="" disabled selected>Loading...</option>
        </select>
      </div>
    </div>
    <div class="sdpi-heading">Safety Timeout</div>
    <div class="sdpi-item">
      <div class="sdpi-item-label">Enable</div>
      <div class="sdpi-item-value">
        <input type="checkbox" id="pttTimeoutEnabled" />
        <label for="pttTimeoutEnabled">Auto-mute if button release is missed</label>
      </div>
    </div>
    <div class="sdpi-item">
      <div class="sdpi-item-label">Auto-mute after</div>
      <div class="sdpi-item-value">
        <input type="number" id="pttTimeout" min="5" max="300" value="60" style="width:60px" /> seconds
      </div>
    </div>
    <div class="sdpi-info">
      Hold to unmute. Red = muted, green = live.<br/>
      Mic mutes on button release, or after the safety timeout if the release is missed.
    </div>
  </div>

  <script src="sdpi-common.js"></script>
  <script>
    initPI(
      function onReady(ws, ai) {
        ws.send(JSON.stringify({
          event: "sendToPlugin",
          action: ai.action,
          context: uuid,
          payload: { request: "getSourceList" }
        }));
      },
      function onMessage(msg) {
        if (msg.event === "sendToPropertyInspector") {
          var payload = msg.payload || {};
          if (payload.event === "sourceList") populateSourceList(payload.sources || []);
        }
        if (msg.event === "didReceiveSettings") { selectCurrentInput(); loadPttTimeout(); }
      }
    );

    function populateSourceList(sources) {
      var select = document.getElementById("input-select");
      select.innerHTML = "";

      if (sources.length === 0) {
        var opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No input devices found";
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      var placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a microphone...";
      placeholder.disabled = true;
      select.appendChild(placeholder);

      sources.forEach(function (source) {
        var opt = document.createElement("option");
        opt.value = source.nodeName;
        opt.textContent = source.name;
        select.appendChild(opt);
      });

      selectCurrentInput();
    }

    function selectCurrentInput() {
      var select = document.getElementById("input-select");
      if (settings.inputName) select.value = settings.inputName;
    }

    function loadPttTimeout() {
      document.getElementById("pttTimeoutEnabled").checked = settings.pttTimeoutEnabled === true;
      if (settings.pttTimeout) document.getElementById("pttTimeout").value = settings.pttTimeout;
    }

    function saveSettings() {
      settings.inputName = document.getElementById("input-select").value || settings.inputName;
      settings.pttTimeoutEnabled = document.getElementById("pttTimeoutEnabled").checked;
      var timeout = parseInt(document.getElementById("pttTimeout").value, 10);
      settings.pttTimeout = Math.min(300, Math.max(5, isNaN(timeout) ? 60 : timeout));
      sendSettings();
    }

    loadPttTimeout();
    document.getElementById("input-select").addEventListener("change", saveSettings);
    document.getElementById("pttTimeoutEnabled").addEventListener("change", saveSettings);
    document.getElementById("pttTimeout").addEventListener("change", saveSettings);
  </script>
</body>
</html>
